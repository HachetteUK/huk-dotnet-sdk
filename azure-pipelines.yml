resources:
- repo: self
  clean: true
phases:
- phase: Phase_1
  displayName: Phase 1 - Windows
  condition: succeeded()
  queue:
    name: Hosted VS2017
  steps:
  - task: DotNetCoreCLI@2
    displayName: 'dotnet build - src'
    inputs:
      projects: '**/src/*.csproj'
      arguments: '-c Release'
  - task: DotNetCoreCLI@2
    displayName: 'dotnet build - Tests'
    inputs:
      projects: '**/test/**/*.csproj'
      # workingDirectory: test/Unit    
  - task: DotNetCoreCLI@2
    displayName: 'dotnet test'
    inputs:
      command: test
      projects: '**/test/**/*.csproj'
- phase: Phase_2
  displayName: Phase 2 -Linux
  condition: succeeded()
  queue:
    name: Hosted Linux Preview
  steps:
  - task: DotNetCoreCLI@2
    displayName: 'dotnet build - src '
    inputs:
      projects: '**/src/*.csproj'
      arguments: '-c Release'
  - task: DotNetCoreCLI@2
    displayName: 'dotnet build - Tests'
    inputs:
      projects: '**/test/**/*.csproj'
  - task: DotNetCoreCLI@2
    displayName: 'dotnet test'
    inputs:
      command: test
      projects: '**/test/**/*.csproj'
- phase: Phase_3
  displayName: Phase 3 - MacOS
  condition: succeeded()
  queue:
    name: Hosted macOS
  steps:
  - task: DotNetCoreCLI@2
    displayName: 'dotnet build - src'
    inputs:
      projects: '**/src/*.csproj'
      arguments: '-c Release'
  - task: DotNetCoreCLI@2
    displayName: 'dotnet build - Tests'
    inputs:
      projects: '**/test/**/*.csproj'
  - task: DotNetCoreCLI@2
    displayName: 'dotnet test'
    inputs:
      command: test
      projects: '**/test/**/*.csproj'
- phase: Phase_4
  dependsOn: 
    - Phase_1
    - Phase_2
    - Phase_3
  displayName: Phase 4 - Nuget
  condition: succeeded()
  queue:
    name: Hosted VS2017
  steps:
  - task: DotNetCoreCLI@2
    displayName: 'dotnet pack'
    inputs:
      command: pack
      packagesToPack: src/Hachette.API.SDK.csproj
      packDirectory: '$(Build.ArtifactStagingDirectory)/Pack'
      versioningScheme: byPrereleaseNumber
      majorVersion: 0
      minorVersion: 1
  # - task: DotNetCoreCLI@2
  #   displayName: 'dotnet push nuget org'
  #   inputs:
  #     command: push
  #     packagesToPush: '$(Build.ArtifactStagingDirectory)/Pack/*.nupkg'
  #     nuGetFeedType: external
  #     publishFeedCredentials: 'AzureDevOps'
  - task: DotNetCoreCLI@2
    displayName: 'dotnet custom push'
    inputs:
      command: custom
      custom: 'nuget push'
      arguments: '$(Build.ArtifactStagingDirectory)\Pack\*.nupkg  -k oy2ayj5wrpt2bsrlfteatthby7fs6tju5m26e5v2msiu7a -s https://api.nuget.org/v3/index.json'










